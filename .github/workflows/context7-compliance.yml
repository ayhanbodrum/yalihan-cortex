name: Context7 Compliance Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  context7-compliance:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress
      
    - name: Run Context7 Compliance Check
      run: |
        echo "ðŸš€ Running Context7 compliance check..."
        php scripts/context7_final_compliance_checker.php
        
    - name: Context7 Compliance Gate
      run: |
        VIOLATIONS=$(php scripts/context7_final_compliance_checker.php | grep "Toplam ihlal:" | sed "s/.*: //")
        echo "Current violations: $VIOLATIONS"
        if [ "$VIOLATIONS" -gt 142 ]; then
          echo "âŒ Context7 compliance check failed! Too many violations: $VIOLATIONS"
          exit 1
        else
          echo "âœ… Context7 compliance check passed!"
        fi
        
    - name: Generate Compliance Report
      if: always()
      run: |
        php scripts/context7-progress-monitor.php > context7-report.txt
        
    - name: Upload Compliance Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: context7-compliance-report
        path: context7-report.txt