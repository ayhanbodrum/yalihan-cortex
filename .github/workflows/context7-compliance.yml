name: Context7 Compliance Check

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  context7-check:
    name: Context7 Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, bcmath, pdo, pdo_mysql

      - name: Install dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Context7 Compliance Check
        run: |
          chmod +x scripts/context7-full-scan.sh
          ./scripts/context7-full-scan.sh --report .context7/ci-compliance-report.md

      - name: Upload compliance report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: context7-compliance-report
          path: .context7/ci-compliance-report.md

      - name: Fail if violations found
        if: failure()
        run: |
          echo "‚ùå Context7 compliance check failed!"
          echo "Please fix the violations before merging."
          exit 1
