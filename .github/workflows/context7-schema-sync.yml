name: Context7 Schema Sync

on:
  push:
    paths:
      - "database/migrations/*.php"
      - "app/Models/*.php"
      - "docs/context7-master.md"
  pull_request:
    paths:
      - "database/migrations/*.php"
      - "app/Models/*.php"
      - "docs/context7-master.md"

jobs:
  sync-schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, dom, fileinfo, mysql

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Install Context7 MCP
        run: npm install -g @upstash/context7-mcp@latest

      - name: Setup MySQL
        run: |
          sudo systemctl start mysql
          mysql -u root -e "CREATE DATABASE IF NOT EXISTS yalihanemlak_db_test;"

      - name: Run migrations
        run: |
          php artisan migrate --force --env=testing
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: yalihanemlak_db_test
          DB_USERNAME: root
          DB_PASSWORD: ""

      - name: Generate Schema
        run: |
          npx @upstash/context7-mcp@latest schema sync \
            --target docs/context7-master.md \
            --database "mysql://root@localhost:3306/yalihanemlak_db_test" \
            --api-key ${{ secrets.CONTEXT7_API_KEY }}

      - name: Generate Mermaid Diagrams
        run: |
          npx @upstash/context7-mcp@latest schema mermaid \
            --output docs/context7-master.md \
            --api-key ${{ secrets.CONTEXT7_API_KEY }}

      - name: Validate Schema Consistency
        run: |
          npx @upstash/context7-mcp@latest schema validate \
            --database "mysql://root@localhost:3306/yalihanemlak_db_test" \
            --master "docs/context7-master.md" \
            --strict \
            --api-key ${{ secrets.CONTEXT7_API_KEY }}

      - name: Update Context7 Memory
        run: |
          npx @upstash/context7-mcp@latest memory sync \
            --schema docs/context7-master.md \
            --api-key ${{ secrets.CONTEXT7_API_KEY }}

      - name: Backup Memory
        run: |
          npx @upstash/context7-mcp@latest memory backup \
            --api-key ${{ secrets.CONTEXT7_API_KEY }}

      - name: Notify Success
        run: echo "Context7 Schema synced successfully"
