#!/bin/bash

echo "ðŸš€ Context7 YalÄ±han BekÃ§i Pre-push Hook"
echo "======================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_error() {
    echo -e "${RED}âŒ [ERROR]${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ… [SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  [WARNING]${NC} $1"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  [INFO]${NC} $1"
}

PROJECT_ROOT=$(git rev-parse --show-toplevel)

# Check if we're pushing to protected branches
protected_branch() {
    local branch="$1"
    [[ "$branch" == "main" || "$branch" == "master" || "$branch" == "develop" ]]
}

# Get current branch
current_branch=$(git branch --show-current)
print_info "Current branch: $current_branch"

# Extra validation for protected branches
if protected_branch "$current_branch"; then
    print_warning "Pushing to protected branch: $current_branch"
    print_info "Running comprehensive validation..."

    # 1. Context7 full validation
    print_info "Running Context7 full validation..."
    if [ -f "$PROJECT_ROOT/artisan" ]; then
        cd "$PROJECT_ROOT"
        if ! php artisan context7:validate-migration --all; then
            print_error "Context7 validation failed"
            print_info "Run: php artisan context7:validate-migration --auto-fix"
            exit 1
        fi
        print_success "Context7 validation passed"
    fi

    # 2. Build assets
    print_info "Testing build process..."
    if [ -f "$PROJECT_ROOT/package.json" ]; then
        cd "$PROJECT_ROOT"
        if ! npm run build > /dev/null 2>&1; then
            print_error "Build failed! Fix build issues before pushing."
            exit 1
        fi
        print_success "Build test passed"
    fi

    # 3. Run tests if available
    print_info "Running tests..."
    if [ -f "$PROJECT_ROOT/vendor/bin/phpunit" ]; then
        cd "$PROJECT_ROOT"
        if ! vendor/bin/phpunit --stop-on-failure > /dev/null 2>&1; then
            print_error "Tests failed"
            exit 1
        fi
        print_success "All tests passed"
    else
        print_warning "PHPUnit not found, skipping tests"
    fi

    # 4. Security check
    print_info "Running security checks..."
    if command -v composer &> /dev/null; then
        cd "$PROJECT_ROOT"
        composer audit > /dev/null 2>&1 || print_warning "Security audit found issues"
    fi

    # 5. Generate health report
    print_info "Generating health report..."
    if [ -f "$PROJECT_ROOT/artisan" ]; then
        cd "$PROJECT_ROOT"
        if php artisan list | grep -q "monitor:project"; then
            php artisan monitor:project --report > /dev/null 2>&1
            print_success "Health report generated"
        fi
    fi

    # 6. Teach YalÄ±han BekÃ§i about the push
    print_info "Teaching YalÄ±han BekÃ§i about the push..."
    if [ -f "$PROJECT_ROOT/artisan" ]; then
        cd "$PROJECT_ROOT"
        if php artisan list | grep -q "bekci:learn"; then
            php artisan bekci:learn "git_push" "Pre-push validation completed for $current_branch branch" > /dev/null 2>&1 || print_warning "Learning failed"
        fi
    fi

    # 7. Final confirmation for main/master
    if [[ "$current_branch" == "main" || "$current_branch" == "master" ]]; then
        echo ""
        print_warning "You are about to push to $current_branch branch!"
        print_info "This will trigger production deployment."
        echo ""
        read -p "Are you sure you want to continue? [y/N] " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Push cancelled by user"
            exit 1
        fi
    fi
fi

# Generate development ideas for feature branches
if [[ "$current_branch" != "main" && "$current_branch" != "master" && "$current_branch" != "develop" ]]; then
    print_info "Generating development ideas for feature branch..."
    if [ -f "$PROJECT_ROOT/artisan" ]; then
        cd "$PROJECT_ROOT"
        if php artisan list | grep -q "ideas:generate"; then
            php artisan ideas:generate --save --category=all --priority=high > /dev/null 2>&1 || true
            print_success "Development ideas generated"
        fi
    fi
fi

print_success "ðŸŽ‰ Pre-push checks completed successfully!"
print_info "Push proceeding to $current_branch branch"

exit 0
