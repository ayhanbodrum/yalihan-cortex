#!/bin/bash

echo "ğŸ“š Context7 YalÄ±han BekÃ§i Post-commit Hook"
echo "=========================================="

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}âœ… [SUCCESS]${NC} $1"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  [INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  [WARNING]${NC} $1"
}

PROJECT_ROOT=$(git rev-parse --show-toplevel)

# Get commit info
commit_hash=$(git rev-parse HEAD)
commit_message=$(git log -1 --pretty=%B)
commit_author=$(git log -1 --pretty=%an)
files_changed=$(git diff-tree --no-commit-id --name-only -r HEAD)

print_info "Processing commit: ${commit_hash:0:8}"
print_info "Author: $commit_author"

# Teach YalÄ±han BekÃ§i about the commit
print_info "Teaching YalÄ±han BekÃ§i about this commit..."
if [ -f "$PROJECT_ROOT/artisan" ]; then
    cd "$PROJECT_ROOT"

    # Record commit metrics for analytics
    print_info "Recording commit metrics for analytics dashboard..."
    php artisan analytics:record-metric \
        "git_activity" "commit_count" "1" --source="post_commit" > /dev/null 2>&1 || true

    php artisan analytics:record-metric \
        "dev_velocity" "daily_commits" "1" --source="post_commit" > /dev/null 2>&1 || true

    if php artisan list | grep -q "bekci:learn"; then
        # Learn from the commit
        commit_data="Commit: $commit_hash\nMessage: $commit_message\nFiles: $files_changed\nAuthor: $commit_author"
        php artisan bekci:learn "git_commit" "$commit_data" > /dev/null 2>&1 && print_success "Commit learned successfully" || print_warning "Learning failed"

        # Generate ideas based on the changes
        if php artisan list | grep -q "ideas:generate"; then
            php artisan ideas:generate --auto --category=optimization --priority=medium > /dev/null 2>&1 && print_success "New ideas generated" || true
        fi

        # Update project monitoring
        if php artisan list | grep -q "monitor:project"; then
            php artisan monitor:project --update > /dev/null 2>&1 && print_success "Project metrics updated" || true
        fi
    fi
fi# Context7 health check after commit
print_info "Running post-commit Context7 validation..."
if [ -f "$PROJECT_ROOT/artisan" ]; then
    cd "$PROJECT_ROOT"
    if php artisan list | grep -q "bekci:health"; then
        php artisan bekci:health --silent > /dev/null 2>&1 && print_success "Context7 health check passed" || print_warning "Context7 issues detected"
    fi
fi

print_success "ğŸ‰ Post-commit processing completed!"
print_info "YalÄ±han BekÃ§i has learned from your commit"

exit 0
