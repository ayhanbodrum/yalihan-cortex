#!/bin/bash
# Context7 YalÄ±han BekÃ§i Pre-Commit Hook
# Otomatik Context7 kurallarÄ± kontrolÃ¼ ve AI learning entegrasyonu

echo "ğŸ” Context7 YalÄ±han BekÃ§i Pre-commit Hook"
echo "========================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_error() {
    echo -e "${RED}âŒ [ERROR]${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ… [SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  [WARNING]${NC} $1"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  [INFO]${NC} $1"
}

# Variables
VIOLATIONS_FOUND=0
AUTO_FIX_APPLIED=0
ERRORS=0
WARNINGS=0

# Get commit info for analytics
PROJECT_ROOT=$(git rev-parse --show-toplevel)
files_changed=$(git diff --cached --name-only | wc -l)
lines_added=$(git diff --cached --numstat | awk '{sum+=$1} END {print sum+0}')
lines_deleted=$(git diff --cached --numstat | awk '{sum+=$2} END {print sum+0}')

print_info "ğŸ“Š Analytics: $files_changed files, +$lines_added/-$lines_deleted lines"

# Record git metrics for analytics
if [ -f "$PROJECT_ROOT/artisan" ]; then
    cd "$PROJECT_ROOT"
    print_info "Recording git metrics for Context7 Analytics Dashboard..."

    php artisan analytics:record-metric \
        "git_activity" "files_changed" "$files_changed" --source="pre_commit" > /dev/null 2>&1 || true

    php artisan analytics:record-metric \
        "git_activity" "lines_added" "$lines_added" --source="pre_commit" > /dev/null 2>&1 || true

    php artisan analytics:record-metric \
        "git_activity" "lines_deleted" "$lines_deleted" --source="pre_commit" > /dev/null 2>&1 || true
fi

        # Log each violation to analytics
        while IFS= read -r line; do
            if [[ $line == *"HATA"* ]] || [[ $line == *"ERROR"* ]]; then
                ERRORS=$((ERRORS + 1))
                violation_type=$(echo "$line" | cut -d':' -f1 | xargs | sed 's/âŒ HATA/Context7_Error/')
                violation_desc=$(echo "$line" | cut -d':' -f2- | xargs)

                # Log to analytics
                if [ -f "$PROJECT_ROOT/artisan" ]; then
                    cd "$PROJECT_ROOT"
                    php artisan analytics:log-violation \
                        "$violation_type" "$violation_desc" \
                        --source="pre_commit" --severity="error" > /dev/null 2>&1 || true
                fi
            elif [[ $line == *"UYARI"* ]] || [[ $line == *"WARNING"* ]]; then
                WARNINGS=$((WARNINGS + 1))
                violation_type=$(echo "$line" | cut -d':' -f1 | xargs | sed 's/âš ï¸  UYARI/Context7_Warning/')
                violation_desc=$(echo "$line" | cut -d':' -f2- | xargs)

                # Log to analytics
                if [ -f "$PROJECT_ROOT/artisan" ]; then
                    cd "$PROJECT_ROOT"
                    php artisan analytics:log-violation \
                        "$violation_type" "$violation_desc" \
                        --source="pre_commit" --severity="warning" > /dev/null 2>&1 || true
                fi
            fi
        done
echo "ğŸ“± Toast Sistemi KontrolÃ¼..."
if git diff --cached --name-only | grep -q "\.blade\.php$\|\.js$\|\.vue$"; then
    if git diff --cached | grep -E "subtleVibrantToast|customToast|toastr\." > /dev/null; then
        echo -e "${RED}âŒ HATA: Deprecated toast sistemi tespit edildi!${NC}"
        echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: window.toast.* kullanÄ±n${NC}"
        echo ""
        git diff --cached | grep -n -E "subtleVibrantToast|customToast|toastr\." | head -5
        echo ""
        ERRORS=$((ERRORS + 1))
    fi
fi

# 2. Layout DosyasÄ± KontrolÃ¼
echo "ğŸ¨ Layout DosyasÄ± KontrolÃ¼..."
if git diff --cached | grep -E "@extends\('layouts\.app'\)|@extends\('Crm::" > /dev/null; then
    echo -e "${RED}âŒ HATA: Deprecated layout dosyasÄ± tespit edildi!${NC}"
    echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: @extends('admin.layouts.admin') kullanÄ±n${NC}"
    echo ""
    git diff --cached | grep -n -E "@extends\('layouts\.app'\)|@extends\('Crm::" | head -5
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# 2.1. Admin Layout TutarlÄ±lÄ±k KontrolÃ¼
echo "ğŸ¨ Admin Layout TutarlÄ±lÄ±k KontrolÃ¼..."
if git diff --cached --name-only | grep -q "resources/views/admin/.*\.blade\.php$"; then
    if git diff --cached | grep -E "@extends\('admin\.layouts\.(neo|app)'\)" > /dev/null; then
        echo -e "${RED}âŒ HATA: GeÃ§ersiz admin layout kullanÄ±mÄ± tespit edildi!${NC}"
        echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: TÃ¼m admin sayfalarÄ± @extends('admin.layouts.admin') kullanmalÄ±${NC}"
        echo ""
        git diff --cached | grep -n -E "@extends\('admin\.layouts\.(neo|app)'\)" | head -5
        echo ""
        ERRORS=$((ERRORS + 1))
    fi
fi

# 3. Route Naming KontrolÃ¼
echo "ğŸ›£ï¸  Route Naming KontrolÃ¼..."
if git diff --cached | grep -E "route\('crm\.|route\('module\." > /dev/null; then
    echo -e "${RED}âŒ HATA: Deprecated route naming tespit edildi!${NC}"
    echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: route('admin.*') kullanÄ±n${NC}"
    echo ""
    git diff --cached | grep -n -E "route\('crm\.|route\('module\." | head -5
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# 4. Database Column KontrolÃ¼ (UyarÄ±)
echo "ğŸ—„ï¸  Database Column KontrolÃ¼..."
if git diff --cached | grep -E "anaKategoriIlanlar|altKategoriIlanlar|ulke_id" > /dev/null; then
    echo -e "${YELLOW}âš ï¸  UYARI: Potansiyel database column hatasÄ± tespit edildi!${NC}"
    echo -e "${GREEN}ğŸ’¡ Ã–NERÄ°: Schema::hasColumn() kontrolÃ¼ kullanÄ±n veya ilanlar() metodunu tercih edin${NC}"
    echo ""
    git diff --cached | grep -n "anaKategoriIlanlar\|altKategoriIlanlar\|ulke_id" | head -5
    echo ""
    WARNINGS=$((WARNINGS + 1))
fi

# 5. Input Label KontrolÃ¼ (UyarÄ±)
echo "â™¿ Accessibility KontrolÃ¼..."
if git diff --cached | grep -E "<input.*type=\"(text|email|checkbox|radio)\"" > /dev/null; then
    # Input var mÄ± kontrol et
    INPUT_COUNT=$(git diff --cached | grep -c "<input.*type=")
    LABEL_COUNT=$(git diff --cached | grep -c "<label.*for=")

    if [ $INPUT_COUNT -gt $LABEL_COUNT ]; then
        echo -e "${YELLOW}âš ï¸  UYARI: Input var ama label eksik olabilir (WCAG Level A)${NC}"
        echo -e "${GREEN}ğŸ’¡ Ã–NERÄ°: Her input iÃ§in label ekleyin (gÃ¶rÃ¼nÃ¼r veya sr-only)${NC}"
        echo ""
        WARNINGS=$((WARNINGS + 1))
    fi
fi

# 6. Garip DeÄŸiÅŸken Ä°simleri KontrolÃ¼
echo "ğŸ” DeÄŸiÅŸken Ä°simleri KontrolÃ¼..."
if git diff --cached | grep -E "\$\$\$\$\$\$\$\$" > /dev/null; then
    echo -e "${RED}âŒ HATA: Garip deÄŸiÅŸken isimleri tespit edildi!${NC}"
    echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: Normal deÄŸiÅŸken isimleri kullanÄ±n${NC}"
    echo ""
    git diff --cached | grep -n "\$\$\$\$\$\$\$\$" | head -5
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# 7. Blade Directive KontrolÃ¼
echo "ğŸ­ Blade Syntax KontrolÃ¼..."
if git diff --cached | grep "@error(" | grep -v "@error('[a-zA-Z_]" > /dev/null; then
    echo -e "${RED}âŒ HATA: Blade directive parametre eksik!${NC}"
    echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: @error('field_name') ÅŸeklinde kullanÄ±n${NC}"
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# 8. YalÄ±han BekÃ§i - Commit Ã–nerisi (UyarÄ± modunda)
echo ""
echo "ğŸ§  YalÄ±han BekÃ§i - Commit Ã–nerisi..."
if [ -f ".yalihan-bekci/tools/git-commit-suggester.sh" ]; then
    bash .yalihan-bekci/tools/git-commit-suggester.sh --suggest --warn 2>/dev/null || true
fi

# SonuÃ§ ve Analytics KayÄ±tlarÄ±
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Record analytics metrics
if [ -f "$PROJECT_ROOT/artisan" ]; then
    cd "$PROJECT_ROOT"

    # Record validation results
    php artisan analytics:record-metric \
        "context7_health" "pre_commit_errors" "$ERRORS" --source="pre_commit" --severity="error" > /dev/null 2>&1 || true

    php artisan analytics:record-metric \
        "context7_health" "pre_commit_warnings" "$WARNINGS" --source="pre_commit" --severity="warning" > /dev/null 2>&1 || true

    # Calculate health score (100 - penalty for errors/warnings)
    health_score=$((100 - (ERRORS * 10) - (WARNINGS * 2)))
    php artisan analytics:record-metric \
        "context7_health" "pre_commit_health_score" "$health_score" --source="pre_commit" > /dev/null 2>&1 || true

    # Teach YalÄ±han BekÃ§i about validation results
    if php artisan list | grep -q "bekci:learn"; then
        validation_data="Pre-commit validation: $ERRORS errors, $WARNINGS warnings, health score: $health_score%"
        php artisan bekci:learn "pre_commit_validation" "$validation_data" > /dev/null 2>&1 || true
    fi
fi

if [ $ERRORS -eq 0 ]; then
    if [ $WARNINGS -eq 0 ]; then
        echo -e "${GREEN}âœ… TÃœM KONTROLLER BAÅARILI!${NC}"
        echo -e "${GREEN}âœ… Context7 v3.1.0 kurallarÄ±na uygun${NC}"
        echo -e "${GREEN}âœ… Analytics verisi kaydedildi${NC}"
        echo -e "${GREEN}âœ… Commit iÅŸlemine devam ediliyor...${NC}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        exit 0
    else
        echo -e "${YELLOW}âš ï¸  ${WARNINGS} UYARI bulundu${NC}"
        echo -e "${GREEN}â„¹ï¸  Analytics verisi kaydedildi${NC}"
        echo -e "${GREEN}â„¹ï¸  Commit iÅŸlemine devam ediliyor...${NC}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        exit 0
    fi
else
    echo -e "${RED}âŒ COMMIT ENGELLENDÄ°!${NC}"
    echo -e "${RED}âŒ ${ERRORS} KRÄ°TÄ°K HATA bulundu${NC}"
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}âš ï¸  ${WARNINGS} UYARI bulundu${NC}"
    fi
    echo -e "${BLUE}ğŸ“Š Analytics verisi kaydedildi (hata tracking iÃ§in)${NC}"
    echo ""
    echo -e "${GREEN}HatalarÄ± dÃ¼zeltin ve tekrar deneyin.${NC}"
    echo -e "${YELLOW}Acil durumlarda: git commit --no-verify${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
fi
