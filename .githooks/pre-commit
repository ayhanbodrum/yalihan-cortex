#!/bin/bash
# Context7 Pre-Commit Hook
# Otomatik Context7 kurallarÄ± kontrolÃ¼

echo "ğŸ” Context7 Pre-Commit KontrolÃ¼ BaÅŸlatÄ±lÄ±yor..."
echo ""

# Renk kodlarÄ±
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Hata sayacÄ±
ERRORS=0
WARNINGS=0

# 1. Toast Sistemi KontrolÃ¼
echo "ğŸ“± Toast Sistemi KontrolÃ¼..."
if git diff --cached --name-only | grep -q "\.blade\.php$\|\.js$\|\.vue$"; then
    if git diff --cached | grep -E "subtleVibrantToast|customToast|toastr\." > /dev/null; then
        echo -e "${RED}âŒ HATA: Deprecated toast sistemi tespit edildi!${NC}"
        echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: window.toast.* kullanÄ±n${NC}"
        echo ""
        git diff --cached | grep -n -E "subtleVibrantToast|customToast|toastr\." | head -5
        echo ""
        ERRORS=$((ERRORS + 1))
    fi
fi

# 2. Layout DosyasÄ± KontrolÃ¼
echo "ğŸ¨ Layout DosyasÄ± KontrolÃ¼..."
if git diff --cached | grep -E "@extends\('layouts\.app'\)|@extends\('Crm::" > /dev/null; then
    echo -e "${RED}âŒ HATA: Deprecated layout dosyasÄ± tespit edildi!${NC}"
    echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: @extends('admin.layouts.neo') kullanÄ±n${NC}"
    echo ""
    git diff --cached | grep -n -E "@extends\('layouts\.app'\)|@extends\('Crm::" | head -5
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# 3. Route Naming KontrolÃ¼
echo "ğŸ›£ï¸  Route Naming KontrolÃ¼..."
if git diff --cached | grep -E "route\('crm\.|route\('module\." > /dev/null; then
    echo -e "${RED}âŒ HATA: Deprecated route naming tespit edildi!${NC}"
    echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: route('admin.*') kullanÄ±n${NC}"
    echo ""
    git diff --cached | grep -n -E "route\('crm\.|route\('module\." | head -5
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# 4. Database Column KontrolÃ¼ (UyarÄ±)
echo "ğŸ—„ï¸  Database Column KontrolÃ¼..."
if git diff --cached | grep -E "anaKategoriIlanlar|altKategoriIlanlar|ulke_id" > /dev/null; then
    echo -e "${YELLOW}âš ï¸  UYARI: Potansiyel database column hatasÄ± tespit edildi!${NC}"
    echo -e "${GREEN}ğŸ’¡ Ã–NERÄ°: Schema::hasColumn() kontrolÃ¼ kullanÄ±n veya ilanlar() metodunu tercih edin${NC}"
    echo ""
    git diff --cached | grep -n "anaKategoriIlanlar\|altKategoriIlanlar\|ulke_id" | head -5
    echo ""
    WARNINGS=$((WARNINGS + 1))
fi

# 5. Input Label KontrolÃ¼ (UyarÄ±)
echo "â™¿ Accessibility KontrolÃ¼..."
if git diff --cached | grep -E "<input.*type=\"(text|email|checkbox|radio)\"" > /dev/null; then
    # Input var mÄ± kontrol et
    INPUT_COUNT=$(git diff --cached | grep -c "<input.*type=")
    LABEL_COUNT=$(git diff --cached | grep -c "<label.*for=")

    if [ $INPUT_COUNT -gt $LABEL_COUNT ]; then
        echo -e "${YELLOW}âš ï¸  UYARI: Input var ama label eksik olabilir (WCAG Level A)${NC}"
        echo -e "${GREEN}ğŸ’¡ Ã–NERÄ°: Her input iÃ§in label ekleyin (gÃ¶rÃ¼nÃ¼r veya sr-only)${NC}"
        echo ""
        WARNINGS=$((WARNINGS + 1))
    fi
fi

# 6. Garip DeÄŸiÅŸken Ä°simleri KontrolÃ¼
echo "ğŸ” DeÄŸiÅŸken Ä°simleri KontrolÃ¼..."
if git diff --cached | grep -E "\$\$\$\$\$\$\$\$" > /dev/null; then
    echo -e "${RED}âŒ HATA: Garip deÄŸiÅŸken isimleri tespit edildi!${NC}"
    echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: Normal deÄŸiÅŸken isimleri kullanÄ±n${NC}"
    echo ""
    git diff --cached | grep -n "\$\$\$\$\$\$\$\$" | head -5
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# 7. Blade Directive KontrolÃ¼
echo "ğŸ­ Blade Syntax KontrolÃ¼..."
if git diff --cached | grep "@error(" | grep -v "@error('[a-zA-Z_]" > /dev/null; then
    echo -e "${RED}âŒ HATA: Blade directive parametre eksik!${NC}"
    echo -e "${GREEN}âœ… Ã‡Ã–ZÃœM: @error('field_name') ÅŸeklinde kullanÄ±n${NC}"
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# 8. YalÄ±han BekÃ§i - Commit Ã–nerisi (UyarÄ± modunda)
echo ""
echo "ğŸ§  YalÄ±han BekÃ§i - Commit Ã–nerisi..."
if [ -f ".yalihan-bekci/tools/git-commit-suggester.sh" ]; then
    bash .yalihan-bekci/tools/git-commit-suggester.sh --suggest --warn 2>/dev/null || true
fi

# SonuÃ§
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $ERRORS -eq 0 ]; then
    if [ $WARNINGS -eq 0 ]; then
        echo -e "${GREEN}âœ… TÃœM KONTROLLER BAÅARILI!${NC}"
        echo -e "${GREEN}âœ… Context7 v3.1.0 kurallarÄ±na uygun${NC}"
        echo -e "${GREEN}âœ… Commit iÅŸlemine devam ediliyor...${NC}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        exit 0
    else
        echo -e "${YELLOW}âš ï¸  ${WARNINGS} UYARI bulundu${NC}"
        echo -e "${GREEN}â„¹ï¸  Commit iÅŸlemine devam ediliyor...${NC}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        exit 0
    fi
else
    echo -e "${RED}âŒ COMMIT ENGELLENDÄ°!${NC}"
    echo -e "${RED}âŒ ${ERRORS} KRÄ°TÄ°K HATA bulundu${NC}"
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}âš ï¸  ${WARNINGS} UYARI bulundu${NC}"
    fi
    echo ""
    echo -e "${GREEN}HatalarÄ± dÃ¼zeltin ve tekrar deneyin.${NC}"
    echo -e "${YELLOW}Acil durumlarda: git commit --no-verify${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
fi
