#!/bin/bash
# ğŸ›¡ï¸ Adres Sistemi Koruma - Pre-Commit Hook
# Tarih: 2025-10-23
# Context7 Compliance Check

echo "ğŸ›¡ï¸ Adres Sistemi Koruma Kontrolleri..."
echo ""

VIOLATIONS=0

# Kontrol 1: Render EksikliÄŸi
echo "1ï¸âƒ£ Render eksikliÄŸi kontrol ediliyor..."
RENDER_CHECK=$(git diff --cached --name-only | grep '\.blade\.php$' | xargs grep -l 'async load' 2>/dev/null)
if [ ! -z "$RENDER_CHECK" ]; then
    for file in $RENDER_CHECK; do
        # Check if loadXXX exists without renderXXX
        if grep -q 'async load' "$file" && ! grep -q '\.render' "$file"; then
            echo "   âš ï¸  UYARI: $file"
            echo "      â†’ loadXXX() var ama renderXXX() eksik olabilir!"
            VIOLATIONS=$((VIOLATIONS + 1))
        fi
    done
fi

# Kontrol 2: Duplicate Function
echo "2ï¸âƒ£ Duplicate fonksiyon kontrol ediliyor..."
STAGED_FILES=$(git diff --cached --name-only | grep '\.(js|blade\.php)$')
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        DUPLICATES=$(grep -oE 'function\s+\w+\s*\(' "$file" | sort | uniq -d)
        if [ ! -z "$DUPLICATES" ]; then
            echo "   ğŸš¨ HATA: $file"
            echo "      â†’ Duplicate fonksiyon tespit edildi:"
            echo "$DUPLICATES" | sed 's/^/         /'
            VIOLATIONS=$((VIOLATIONS + 1))
        fi
    fi
done

# Kontrol 3: API Endpoint KontrolÃ¼
echo "3ï¸âƒ£ API endpoint kontrolÃ¼..."
NEW_FETCHES=$(git diff --cached | grep -oE "fetch\(['\"]\/api\/[^'\"]+['\"]" | sed "s/fetch(['\"]//;s/['\"].*//" | sort -u)
if [ ! -z "$NEW_FETCHES" ]; then
    for endpoint in $NEW_FETCHES; do
        # Extract endpoint pattern for route check
        ROUTE_PATTERN=$(echo "$endpoint" | sed 's/{[^}]*}/\{[^}]*\}/')
        if ! grep -qE "Route::get\(['\"]$ROUTE_PATTERN" routes/api.php 2>/dev/null; then
            echo "   âš ï¸  UYARI: API endpoint eksik olabilir"
            echo "      â†’ $endpoint"
            echo "      â†’ routes/api.php'de tanÄ±mlÄ± mÄ± kontrol et"
        fi
    done
fi

# Kontrol 4: Init() EksikliÄŸi
echo "4ï¸âƒ£ Alpine.js init() kontrolÃ¼..."
ALPINE_FILES=$(git diff --cached --name-only | grep '\.blade\.php$')
for file in $ALPINE_FILES; do
    if [ -f "$file" ]; then
        if grep -q 'x-data="' "$file" && ! grep -q 'init()' "$file"; then
            echo "   âš ï¸  UYARI: $file"
            echo "      â†’ Alpine component var ama init() eksik olabilir"
        fi
    fi
done

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $VIOLATIONS -gt 0 ]; then
    echo "âš ï¸  $VIOLATIONS potansiyel sorun tespit edildi!"
    echo ""
    echo "Devam etmek iÃ§in:"
    echo "  â†’ SorunlarÄ± dÃ¼zelt ve tekrar commit et"
    echo "  â†’ VEYA kontrolleri atla: git commit --no-verify"
    echo ""
    echo "ğŸ“š Kurallar: .context7/ADRES_SISTEMI_KORUMA_KURALLARI.md"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
else
    echo "âœ… TÃ¼m kontroller baÅŸarÄ±lÄ±!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 0
fi

