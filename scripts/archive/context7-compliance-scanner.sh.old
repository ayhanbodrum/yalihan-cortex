#!/bin/bash

# Context7 Compliance Scanner
# TÃ¼m projeyi tarar ve Context7 kurallarÄ±na aykÄ±rÄ± pattern'leri bulur
# KullanÄ±m: ./scripts/context7-compliance-scanner.sh [--fix] [--report]

set -e

# Renkler
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# SeÃ§enekler
FIX_MODE=false
REPORT_MODE=false
OUTPUT_FILE=""

# Parametreleri parse et
while [[ $# -gt 0 ]]; do
    case $1 in
        --fix)
            FIX_MODE=true
            shift
            ;;
        --report)
            REPORT_MODE=true
            OUTPUT_FILE="${2:-.context7/compliance-report-$(date +%Y%m%d-%H%M%S).md}"
            shift 2
            ;;
        *)
            echo "KullanÄ±m: $0 [--fix] [--report [dosya]]"
            exit 1
            ;;
    esac
done

# Ä°statistikler
TOTAL_VIOLATIONS=0
CRITICAL_VIOLATIONS=0
HIGH_VIOLATIONS=0
MEDIUM_VIOLATIONS=0
LOW_VIOLATIONS=0

# Rapor baÅŸlat
if [ "$REPORT_MODE" = true ]; then
    mkdir -p "$(dirname "$OUTPUT_FILE")"
    {
        echo "# Context7 Compliance Report"
        echo ""
        echo "**Tarih:** $(date '+%Y-%m-%d %H:%M:%S')"
        echo "**Durum:** âš ï¸ TARAMA TAMAMLANDI"
        echo ""
        echo "---"
        echo ""
    } > "$OUTPUT_FILE"
fi

# Log fonksiyonu
log_violation() {
    local severity=$1
    local file=$2
    local line=$3
    local pattern=$4
    local message=$5
    
    TOTAL_VIOLATIONS=$((TOTAL_VIOLATIONS + 1))
    
    case $severity in
        critical)
            CRITICAL_VIOLATIONS=$((CRITICAL_VIOLATIONS + 1))
            echo -e "${RED}âŒ CRITICAL${NC}: $file:$line - $pattern"
            echo -e "   ${RED}â†’${NC} $message"
            ;;
        high)
            HIGH_VIOLATIONS=$((HIGH_VIOLATIONS + 1))
            echo -e "${YELLOW}âš ï¸  HIGH${NC}: $file:$line - $pattern"
            echo -e "   ${YELLOW}â†’${NC} $message"
            ;;
        medium)
            MEDIUM_VIOLATIONS=$((MEDIUM_VIOLATIONS + 1))
            echo -e "${BLUE}â„¹ï¸  MEDIUM${NC}: $file:$line - $pattern"
            ;;
        low)
            LOW_VIOLATIONS=$((LOW_VIOLATIONS + 1))
            echo -e "${GREEN}â„¹ï¸  LOW${NC}: $file:$line - $pattern"
            ;;
    esac
    
    if [ "$REPORT_MODE" = true ]; then
        {
            echo "### $severity: $file:$line"
            echo ""
            echo "**Pattern:** \`$pattern\`"
            echo "**Mesaj:** $message"
            echo ""
        } >> "$OUTPUT_FILE"
    fi
}

# 1. Database Field Violations
echo -e "${BLUE}ğŸ” Database Field Violations Kontrol Ediliyor...${NC}"
echo ""

# order â†’ display_order
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    content=$(echo "$line" | cut -d: -f3-)
    
    if echo "$content" | grep -qE "'order'|"order"|order\s*=>"; then
        if ! echo "$content" | grep -q "display_order"; then
            log_violation "critical" "$file" "$line_num" "'order'" "order â†’ display_order kullanÄ±lmalÄ±"
        fi
    fi
done < <(grep -rnE "'order'|"order"|order\s*=>" --include="*.php" --include="*.blade.php" app/ database/ resources/ 2>/dev/null | grep -v "display_order" | grep -v "\$order" | grep -v "//" | grep -v "orderBy" | head -50)

# durum â†’ status
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "'durum'" "durum â†’ status kullanÄ±lmalÄ±"
done < <(grep -rnE "'durum'|"durum"" --include="*.php" --include="*.blade.php" app/ database/ resources/ 2>/dev/null | grep -v "status" | head -20)

# aktif â†’ status
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "'aktif'" "aktif â†’ status kullanÄ±lmalÄ±"
done < <(grep -rnE "'aktif'|"aktif"" --include="*.php" --include="*.blade.php" app/ database/ resources/ 2>/dev/null | grep -v "status" | head -20)

# is_active â†’ status
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "high" "$file" "$line_num" "is_active" "is_active â†’ status kullanÄ±lmalÄ±"
done < <(grep -rnE "is_active" --include="*.php" --include="*.blade.php" app/ database/ resources/ 2>/dev/null | grep -v "status" | head -20)

# enabled â†’ status (sadece status field olarak)
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    content=$(echo "$line" | cut -d: -f3-)
    
    # enabled field olarak kullanÄ±lÄ±yorsa (fillable, casts, where, etc.)
    if echo "$content" | grep -qE "fillable.*enabled|casts.*enabled|where.*enabled|->enabled"; then
        log_violation "critical" "$file" "$line_num" "enabled" "enabled â†’ status kullanÄ±lmalÄ± (status field olarak)"
    fi
done < <(grep -rnE "enabled" --include="*.php" app/Models/ database/migrations/ 2>/dev/null | grep -v "weekend_pricing_enabled\|sync_enabled\|feature.*enabled" | head -20)

# sehir â†’ il
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "sehir" "sehir â†’ il kullanÄ±lmalÄ±"
done < <(grep -rnE "'sehir'|"sehir"|sehir_id" --include="*.php" --include="*.blade.php" app/ database/ resources/ 2>/dev/null | grep -v "il_id" | head -20)

# musteri â†’ kisi
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "musteri" "musteri â†’ kisi kullanÄ±lmalÄ±"
done < <(grep -rnE "'musteri'|"musteri"|musteri_id" --include="*.php" --include="*.blade.php" app/ database/ resources/ 2>/dev/null | grep -v "kisi" | head -20)

echo ""

# 2. CSS Class Violations
echo -e "${BLUE}ğŸ” CSS Class Violations Kontrol Ediliyor...${NC}"
echo ""

# neo-* classes
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "neo-*" "Neo Design System yasak - Tailwind CSS kullanÄ±lmalÄ±"
done < <(grep -rnE "neo-[a-z-]+" --include="*.blade.php" --include="*.php" resources/ app/ 2>/dev/null | head -30)

# Bootstrap classes
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "high" "$file" "$line_num" "btn-*|card-*|form-control" "Bootstrap yasak - Tailwind CSS kullanÄ±lmalÄ±"
done < <(grep -rnE "btn-|card-|form-control" --include="*.blade.php" resources/ 2>/dev/null | head -20)

echo ""

# 3. JavaScript Violations
echo -e "${BLUE}ğŸ” JavaScript Violations Kontrol Ediliyor...${NC}"
echo ""

# jQuery
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "jQuery" "jQuery yasak - Vanilla JS kullanÄ±lmalÄ±"
done < <(grep -rnE "\$\(|jQuery|\.ajax\(|\.get\(|\.post\(" --include="*.js" --include="*.blade.php" resources/ public/ 2>/dev/null | grep -v "node_modules" | head -20)

# subtleVibrantToast
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "subtleVibrantToast" "subtleVibrantToast yasak - window.toast kullanÄ±lmalÄ±"
done < <(grep -rnE "subtleVibrantToast" --include="*.js" --include="*.blade.php" resources/ public/ 2>/dev/null | head -10)

echo ""

# 4. Layout Violations
echo -e "${BLUE}ğŸ” Layout Violations Kontrol Ediliyor...${NC}"
echo ""

# layouts.app
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "layouts.app" "layouts.app yasak - admin.layouts.neo kullanÄ±lmalÄ±"
done < <(grep -rnE "@extends\('layouts\.app'\)" --include="*.blade.php" resources/ 2>/dev/null | head -10)

echo ""

# 5. Route Violations
echo -e "${BLUE}ğŸ” Route Violations Kontrol Ediliyor...${NC}"
echo ""

# crm.* routes
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "route('crm." "crm.* routes yasak - admin.* kullanÄ±lmalÄ±"
done < <(grep -rnE "route\('crm\." --include="*.php" --include="*.blade.php" app/ resources/ 2>/dev/null | head -20)

echo ""

# 6. Migration Compliance
echo -e "${BLUE}ğŸ” Migration Compliance Kontrol Ediliyor...${NC}"
echo ""

# Migration'larda order kolonu
while IFS= read -r line; do
    file=$(echo "$line" | cut -d: -f1)
    line_num=$(echo "$line" | cut -d: -f2)
    content=$(echo "$line" | cut -d: -f3-)
    
    if echo "$content" | grep -qE "\$table->.*\('order'\)"; then
        if ! echo "$content" | grep -q "display_order"; then
            log_violation "critical" "$file" "$line_num" "\$table->.*('order')" "Migration'da order â†’ display_order kullanÄ±lmalÄ±"
        fi
    fi
done < <(grep -rnE "\$table->.*\('order'\)" database/migrations/ 2>/dev/null | head -20)

echo ""

# Ã–zet
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ“Š TARAMA Ã–ZETÄ°${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "Toplam Ä°hlal: ${RED}$TOTAL_VIOLATIONS${NC}"
echo -e "  ${RED}âŒ Critical:${NC} $CRITICAL_VIOLATIONS"
echo -e "  ${YELLOW}âš ï¸  High:${NC} $HIGH_VIOLATIONS"
echo -e "  ${BLUE}â„¹ï¸  Medium:${NC} $MEDIUM_VIOLATIONS"
echo -e "  ${GREEN}â„¹ï¸  Low:${NC} $LOW_VIOLATIONS"
echo ""

if [ "$REPORT_MODE" = true ]; then
    {
        echo "## ğŸ“Š Ã–zet"
        echo ""
        echo "- **Toplam Ä°hlal:** $TOTAL_VIOLATIONS"
        echo "- **Critical:** $CRITICAL_VIOLATIONS"
        echo "- **High:** $HIGH_VIOLATIONS"
        echo "- **Medium:** $MEDIUM_VIOLATIONS"
        echo "- **Low:** $LOW_VIOLATIONS"
        echo ""
        echo "---"
        echo ""
        echo "**Rapor OluÅŸturulma Tarihi:** $(date '+%Y-%m-%d %H:%M:%S')"
    } >> "$OUTPUT_FILE"
    echo -e "${GREEN}âœ… Rapor oluÅŸturuldu: $OUTPUT_FILE${NC}"
fi

if [ $TOTAL_VIOLATIONS -eq 0 ]; then
    echo -e "${GREEN}âœ… Harika! HiÃ§ ihlal bulunamadÄ±.${NC}"
    exit 0
else
    echo -e "${YELLOW}âš ï¸  $TOTAL_VIOLATIONS ihlal bulundu.${NC}"
    if [ "$FIX_MODE" = false ]; then
        echo -e "${BLUE}ğŸ’¡ Otomatik dÃ¼zeltme iÃ§in: $0 --fix${NC}"
    fi
    exit 1
fi

