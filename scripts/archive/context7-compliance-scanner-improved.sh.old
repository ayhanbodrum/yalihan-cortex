#!/bin/bash

# Context7 Compliance Scanner - Improved Version
# TÃ¼m projeyi tarar ve Context7 kurallarÄ±na aykÄ±rÄ± pattern'leri bulur
# KullanÄ±m: ./scripts/context7-compliance-scanner-improved.sh [--report] [--json]

set -e

# Renkler
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# SeÃ§enekler
REPORT_MODE=false
JSON_MODE=false
OUTPUT_FILE=""

# Parametreleri parse et
while [[ $# -gt 0 ]]; do
    case $1 in
        --report)
            REPORT_MODE=true
            OUTPUT_FILE="${2:-.context7/compliance-report-$(date +%Y%m%d-%H%M%S).md}"
            shift 2
            ;;
        --json)
            JSON_MODE=true
            OUTPUT_FILE="${2:-.context7/compliance-report-$(date +%Y%m%d-%H%M%S).json}"
            shift 2
            ;;
        *)
            echo "KullanÄ±m: $0 [--report [dosya]] [--json [dosya]]"
            exit 1
            ;;
    esac
done

# Ä°statistikler
declare -A VIOLATIONS
VIOLATIONS[total]=0
VIOLATIONS[critical]=0
VIOLATIONS[high]=0
VIOLATIONS[medium]=0
VIOLATIONS[low]=0

# Violation kayÄ±tlarÄ±
VIOLATION_LIST=()

# Log fonksiyonu
log_violation() {
    local severity=$1
    local file=$2
    local line=$3
    local pattern=$4
    local message=$5
    local replacement=$6
    
    VIOLATIONS[total]=$((VIOLATIONS[total] + 1))
    VIOLATIONS[$severity]=$((${VIOLATIONS[$severity]} + 1))
    
    VIOLATION_LIST+=("$severity|$file|$line|$pattern|$message|$replacement")
    
    case $severity in
        critical)
            echo -e "${RED}âŒ CRITICAL${NC}: $file:$line"
            echo -e "   ${RED}Pattern:${NC} $pattern"
            echo -e "   ${RED}â†’${NC} $message"
            ;;
        high)
            echo -e "${YELLOW}âš ï¸  HIGH${NC}: $file:$line"
            echo -e "   ${YELLOW}Pattern:${NC} $pattern"
            echo -e "   ${YELLOW}â†’${NC} $message"
            ;;
        medium)
            echo -e "${BLUE}â„¹ï¸  MEDIUM${NC}: $file:$line - $pattern"
            ;;
        low)
            echo -e "${GREEN}â„¹ï¸  LOW${NC}: $file:$line - $pattern"
            ;;
    esac
    echo ""
}

# Yorum satÄ±rÄ± kontrolÃ¼
is_comment_line() {
    local line="$1"
    if [[ "$line" =~ ^[[:space:]]*(//|\*|#) ]]; then
        return 0
    fi
    return 1
}

# Exclude kontrolÃ¼
should_exclude() {
    local line="$1"
    local excludes=("$@")
    
    for exclude in "${excludes[@]}"; do
        if [[ "$line" == *"$exclude"* ]]; then
            return 0
        fi
    done
    return 1
}

# 1. Database Field Violations
echo -e "${BLUE}ğŸ” Database Field Violations Kontrol Ediliyor...${NC}"
echo ""

# order â†’ display_order (sadece gerÃ§ek kullanÄ±mlar)
while IFS= read -r result; do
    file=$(echo "$result" | cut -d: -f1)
    line_num=$(echo "$result" | cut -d: -f2)
    content=$(echo "$result" | cut -d: -f3- | xargs)
    
    # Yorum satÄ±rÄ± kontrolÃ¼
    if is_comment_line "$content"; then
        continue
    fi
    
    # Exclude kontrolÃ¼
    if should_exclude "$content" "display_order" "\$order" "orderBy" "//"; then
        continue
    fi
    
    # Sadece gerÃ§ek kullanÄ±mlar (fillable, casts, where, etc.)
    if [[ "$content" =~ (fillable|casts|where|->|'order'|"order"|order\s*=>) ]]; then
        log_violation "critical" "$file" "$line_num" "'order'" "order â†’ display_order kullanÄ±lmalÄ±" "display_order"
    fi
done < <(grep -rnE "'order'|\"order\"|order\s*=>" --include="*.php" app/Models/ database/migrations/ 2>/dev/null | head -30)

# durum â†’ status
while IFS= read -r result; do
    file=$(echo "$result" | cut -d: -f1)
    line_num=$(echo "$result" | cut -d: -f2)
    content=$(echo "$result" | cut -d: -f3- | xargs)
    
    if is_comment_line "$content" || should_exclude "$content" "status"; then
        continue
    fi
    
    log_violation "critical" "$file" "$line_num" "'durum'" "durum â†’ status kullanÄ±lmalÄ±" "status"
done < <(grep -rnE "'durum'|\"durum\"" --include="*.php" app/ database/ 2>/dev/null | head -10)

# aktif â†’ status
while IFS= read -r result; do
    file=$(echo "$result" | cut -d: -f1)
    line_num=$(echo "$result" | cut -d: -f2)
    content=$(echo "$result" | cut -d: -f3- | xargs)
    
    if is_comment_line "$content" || should_exclude "$content" "status"; then
        continue
    fi
    
    log_violation "critical" "$file" "$line_num" "'aktif'" "aktif â†’ status kullanÄ±lmalÄ±" "status"
done < <(grep -rnE "'aktif'|\"aktif\"" --include="*.php" app/ database/ 2>/dev/null | head -10)

# sehir â†’ il
while IFS= read -r result; do
    file=$(echo "$result" | cut -d: -f1)
    line_num=$(echo "$result" | cut -d: -f2)
    content=$(echo "$result" | cut -d: -f3- | xargs)
    
    if is_comment_line "$content" || should_exclude "$content" "il_id"; then
        continue
    fi
    
    log_violation "critical" "$file" "$line_num" "sehir" "sehir â†’ il kullanÄ±lmalÄ±" "il"
done < <(grep -rnE "'sehir'|\"sehir\"|sehir_id" --include="*.php" app/ database/ 2>/dev/null | head -10)

echo ""

# 2. CSS Class Violations
echo -e "${BLUE}ğŸ” CSS Class Violations Kontrol Ediliyor...${NC}"
echo ""

# neo-* classes
while IFS= read -r result; do
    file=$(echo "$result" | cut -d: -f1)
    line_num=$(echo "$result" | cut -d: -f2)
    content=$(echo "$result" | cut -d: -f3- | xargs)
    
    if is_comment_line "$content"; then
        continue
    fi
    
    log_violation "critical" "$file" "$line_num" "neo-*" "Neo Design System yasak - Tailwind CSS kullanÄ±lmalÄ±" "Tailwind CSS"
done < <(grep -rnE "neo-[a-z-]+" --include="*.blade.php" resources/ 2>/dev/null | head -20)

echo ""

# 3. Layout Violations
echo -e "${BLUE}ğŸ” Layout Violations Kontrol Ediliyor...${NC}"
echo ""

# layouts.app
while IFS= read -r result; do
    file=$(echo "$result" | cut -d: -f1)
    line_num=$(echo "$result" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "layouts.app" "layouts.app yasak - admin.layouts.neo kullanÄ±lmalÄ±" "admin.layouts.neo"
done < <(grep -rnE "@extends\('layouts\.app'\)" --include="*.blade.php" resources/ 2>/dev/null | head -10)

echo ""

# 4. Route Violations
echo -e "${BLUE}ğŸ” Route Violations Kontrol Ediliyor...${NC}"
echo ""

# crm.* routes
while IFS= read -r result; do
    file=$(echo "$result" | cut -d: -f1)
    line_num=$(echo "$result" | cut -d: -f2)
    log_violation "critical" "$file" "$line_num" "route('crm." "crm.* routes yasak - admin.* kullanÄ±lmalÄ±" "route('admin."
done < <(grep -rnE "route\('crm\." --include="*.php" --include="*.blade.php" app/ resources/ 2>/dev/null | head -10)

echo ""

# Ã–zet
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ“Š TARAMA Ã–ZETÄ°${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "Toplam Ä°hlal: ${RED}${VIOLATIONS[total]}${NC}"
echo -e "  ${RED}âŒ Critical:${NC} ${VIOLATIONS[critical]}"
echo -e "  ${YELLOW}âš ï¸  High:${NC} ${VIOLATIONS[high]}"
echo -e "  ${BLUE}â„¹ï¸  Medium:${NC} ${VIOLATIONS[medium]}"
echo -e "  ${GREEN}â„¹ï¸  Low:${NC} ${VIOLATIONS[low]}"
echo ""

# Rapor oluÅŸtur
if [ "$REPORT_MODE" = true ] || [ "$JSON_MODE" = true ]; then
    mkdir -p "$(dirname "$OUTPUT_FILE")"
    
    if [ "$JSON_MODE" = true ]; then
        # JSON rapor
        {
            echo "{"
            echo "  \"date\": \"$(date '+%Y-%m-%d %H:%M:%S')\","
            echo "  \"status\": \"completed\","
            echo "  \"summary\": {"
            echo "    \"total\": ${VIOLATIONS[total]},"
            echo "    \"critical\": ${VIOLATIONS[critical]},"
            echo "    \"high\": ${VIOLATIONS[high]},"
            echo "    \"medium\": ${VIOLATIONS[medium]},"
            echo "    \"low\": ${VIOLATIONS[low]}"
            echo "  },"
            echo "  \"violations\": ["
            
            first=true
            for violation in "${VIOLATION_LIST[@]}"; do
                IFS='|' read -r severity file line pattern message replacement <<< "$violation"
                if [ "$first" = false ]; then
                    echo ","
                fi
                first=false
                echo "    {"
                echo "      \"severity\": \"$severity\","
                echo "      \"file\": \"$file\","
                echo "      \"line\": $line,"
                echo "      \"pattern\": \"$pattern\","
                echo "      \"message\": \"$message\","
                echo "      \"replacement\": \"$replacement\""
                echo -n "    }"
            done
            
            echo ""
            echo "  ]"
            echo "}"
        } > "$OUTPUT_FILE"
    else
        # Markdown rapor
        {
            echo "# Context7 Compliance Report"
            echo ""
            echo "**Tarih:** $(date '+%Y-%m-%d %H:%M:%S')"
            echo "**Durum:** âš ï¸ TARAMA TAMAMLANDI"
            echo ""
            echo "---"
            echo ""
            echo "## ğŸ“Š Ã–zet"
            echo ""
            echo "- **Toplam Ä°hlal:** ${VIOLATIONS[total]}"
            echo "- **Critical:** ${VIOLATIONS[critical]}"
            echo "- **High:** ${VIOLATIONS[high]}"
            echo "- **Medium:** ${VIOLATIONS[medium]}"
            echo "- **Low:** ${VIOLATIONS[low]}"
            echo ""
            echo "---"
            echo ""
            echo "## Ä°hlaller"
            echo ""
            
            for violation in "${VIOLATION_LIST[@]}"; do
                IFS='|' read -r severity file line pattern message replacement <<< "$violation"
                echo "### $severity: $file:$line"
                echo ""
                echo "**Pattern:** \`$pattern\`"
                echo "**Mesaj:** $message"
                if [ -n "$replacement" ]; then
                    echo "**Replacement:** \`$replacement\`"
                fi
                echo ""
                echo "---"
                echo ""
            done
        } > "$OUTPUT_FILE"
    fi
    
    echo -e "${GREEN}âœ… Rapor oluÅŸturuldu: $OUTPUT_FILE${NC}"
fi

if [ ${VIOLATIONS[total]} -eq 0 ]; then
    echo -e "${GREEN}âœ… Harika! HiÃ§ ihlal bulunamadÄ±.${NC}"
    exit 0
else
    echo -e "${YELLOW}âš ï¸  ${VIOLATIONS[total]} ihlal bulundu.${NC}"
    exit 1
fi

